<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>動画アップロード＆圧縮</title>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/ffmpeg.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 30px; }
    #spinner { display: none; margin: 20px auto; border: 6px solid #ccc; border-top: 6px solid #4285F4; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .progress-bar { width: 80%; height: 20px; background-color: #f1f1f1; margin: 20px auto; border-radius: 10px; overflow: hidden; }
    .progress { height: 100%; background-color: #4285F4; width: 0%; transition: width 0.3s; }
    #fileInfo { margin: 10px 0; }
    .error { color: red; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>動画アップロード＆圧縮</h1>
  <input type="file" id="videoInput" accept="video/*"><br>
  <div id="fileInfo"></div>
  <button id="compressButton" disabled>圧縮してアップロード</button>
  <div id="spinner"></div>
  <div class="progress-bar">
    <div class="progress" id="progressBar"></div>
  </div>
  <p id="status">ファイルを選択してください</p>
  <div id="error" class="error"></div>

  <script>
    // FFmpegオブジェクトをグローバルに保持
    let ffmpeg = null;
    let currentFile = null;
    let processing = false;

    // FFmpegの初期化関数
    async function initFFmpeg() {
      if (!ffmpeg) {
        // FFmpegがロードされていることを確認
        if (typeof FFmpeg === 'undefined') {
          throw new Error('FFmpegライブラリが読み込まれていません');
        }
        
        const { createFFmpeg, fetchFile } = FFmpeg;
        ffmpeg = createFFmpeg({
          log: true,
          progress: ({ ratio }) => {
            const percent = Math.round(ratio * 100);
            document.getElementById('status').innerText = `ffmpeg.wasm 初期化中... ${percent}%`;
          }
        });
        await ffmpeg.load();
      }
      return ffmpeg;
    }

    // イベントリスナーの設定
    document.addEventListener('DOMContentLoaded', () => {
      // ファイル選択イベント
      document.getElementById('videoInput').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          currentFile = e.target.files[0];
          document.getElementById('compressButton').disabled = false;
          document.getElementById('fileInfo').innerHTML = 
            `<strong>選択ファイル:</strong> ${currentFile.name}<br>
             <strong>サイズ:</strong> ${(currentFile.size / 1024 / 1024).toFixed(2)} MB`;
          document.getElementById('status').innerText = '「圧縮してアップロード」ボタンをクリック';
        }
      });

      // 圧縮ボタンクリックイベント
      document.getElementById('compressButton').addEventListener('click', async () => {
        if (processing) return;
        if (!currentFile) {
          showError('動画ファイルを選択してください');
          return;
        }
        processing = true;
        document.getElementById('compressButton').disabled = true;
        await startCompression();
      });
    });

    // エラー表示関数
    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.innerText = message;
      setTimeout(() => errorDiv.innerText = '', 5000);
    }

    // 圧縮処理
    async function startCompression() {
      try {
        clearError();
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('status').innerText = 'ffmpeg.wasm をロード中...';
        
        const file = currentFile;
        
        // ファイルサイズチェック (100MB制限)
        if (file.size > 100 * 1024 * 1024) {
          showError('ファイルサイズが100MBを超えています。より小さいファイルを選択してください。');
          resetUI();
          return;
        }

        // FFmpeg初期化
        const ffmpegInstance = await initFFmpeg();
        document.getElementById('status').innerText = '圧縮処理を開始...';
        
        // ファイルシステムに書き込み
        ffmpegInstance.FS('writeFile', file.name, await FFmpeg.fetchFile(file));
        
        // 進捗表示設定
        ffmpegInstance.setProgress(({ ratio }) => {
          const percent = Math.round(ratio * 100);
          document.getElementById('progressBar').style.width = `${percent}%`;
          document.getElementById('status').innerText = `圧縮中... ${percent}%`;
        });

        // 圧縮実行 (解像度を720pにダウンスケール)
        await ffmpegInstance.run(
          '-i', file.name,
          '-vf', 'scale=-2:720',
          '-c:v', 'libx264',
          '-crf', '28',
          '-preset', 'fast',
          '-c:a', 'aac',
          '-b:a', '64k',
          'output.mp4'
        );

        // 出力ファイル取得
        const data = ffmpegInstance.FS('readFile', 'output.mp4');
        const blob = new Blob([data.buffer], { type: 'video/mp4' });
        
        // 圧縮後のサイズチェック
        const compressedSize = blob.size / 1024 / 1024;
        if (compressedSize > 50) {
          showError(`圧縮後も50MBを超えています (${compressedSize.toFixed(2)}MB)。別のファイルをお試しください。`);
          resetUI();
          return;
        }

        document.getElementById('status').innerText = `圧縮完了! (${compressedSize.toFixed(2)}MB) アップロード中...`;
        await uploadToGAS(blob);
        
      } catch (err) {
        console.error('エラー:', err);
        showError(`処理エラー: ${err.message || err}`);
        resetUI();
      }
    }

    // UIリセット
    function resetUI() {
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('compressButton').disabled = false;
      processing = false;
    }

    // エラークリア
    function clearError() {
      document.getElementById('error').innerText = '';
    }

    // GASへのアップロード
    async function uploadToGAS(blob) {
      try {
        document.getElementById('status').innerText = 'サーバーに送信中...';
        
        // Base64エンコードして送信
        const reader = new FileReader();
        const result = await new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
        
        const base64Data = result.split(',')[1];
        const response = await fetch(
          'https://script.google.com/macros/s/AKfycbzta37TGo2wIQ3IQOUm2dyLn_RXL7eIxeE2HYLmzRtM0xT2O0ffeoZ0gL66EXTjc-iyhg/exec', 
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `filedata=${encodeURIComponent(base64Data)}&filename=compressed_video.mp4&mimetype=video/mp4`
          }
        );
        
        if (!response.ok) {
          throw new Error(`サーバーエラー: ${response.status}`);
        }
        
        const text = await response.text();
        document.getElementById('status').innerText = `アップロード成功: ${text}`;
      } catch (err) {
        showError(`アップロード失敗: ${err.message || err}`);
      } finally {
        resetUI();
      }
    }
  </script>
</body>
</html>
