<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>動画アップロード＆圧縮</title>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/ffmpeg.min.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 30px; }
    #spinner { display: none; margin: 20px auto; border: 6px solid #ccc; border-top: 6px solid #4285F4; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .progress-bar { width: 80%; height: 20px; background-color: #f1f1f1; margin: 20px auto; border-radius: 10px; overflow: hidden; }
    .progress { height: 100%; background-color: #4285F4; width: 0%; transition: width 0.3s; }
    #fileInfo { margin: 10px 0; }
  </style>
</head>
<body>
  <h1>動画アップロード＆圧縮</h1>
  <input type="file" id="videoInput" accept="video/*"><br>
  <div id="fileInfo"></div>
  <button id="compressButton" disabled>圧縮してアップロード</button>
  <div id="spinner"></div>
  <div class="progress-bar">
    <div class="progress" id="progressBar"></div>
  </div>
  <p id="status">ファイルを選択してください</p>

  <script>
    let ffmpeg;
    let currentFile = null;
    let processing = false;

    document.getElementById('videoInput').addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        currentFile = e.target.files[0];
        document.getElementById('compressButton').disabled = false;
        document.getElementById('fileInfo').innerText = 
          `選択ファイル: ${currentFile.name} (${(currentFile.size / 1024 / 1024).toFixed(2)} MB)`;
        document.getElementById('status').innerText = '「圧縮してアップロード」ボタンをクリック';
      }
    });

    document.getElementById('compressButton').addEventListener('click', async () => {
      if (processing) return;
      if (!currentFile) {
        alert('動画ファイルを選択してください');
        return;
      }
      processing = true;
      document.getElementById('compressButton').disabled = true;
      startCompression();
    });

    async function initFFmpeg() {
      if (!ffmpeg) {
        const { createFFmpeg, fetchFile } = FFmpeg;
        ffmpeg = createFFmpeg({
          log: true,
          progress: ({ ratio }) => {
            const percent = Math.round(ratio * 100);
            document.getElementById('status').innerText = `ffmpeg.wasm 初期化中... ${percent}%`;
          }
        });
        await ffmpeg.load();
      }
      return ffmpeg;
    }

    async function startCompression() {
      try {
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('status').innerText = 'ffmpeg.wasm をロード中...';
        
        const file = currentFile;
        
        // ファイルサイズチェック (50MB制限)
        if (file.size > 50 * 1024 * 1024) {
          alert('ファイルサイズが50MBを超えています。より小さいファイルを選択してください。');
          resetUI();
          return;
        }

        // FFmpeg初期化
        const ffmpeg = await initFFmpeg();
        document.getElementById('status').innerText = '圧縮処理を開始...';
        
        // ファイルシステムに書き込み
        ffmpeg.FS('writeFile', file.name, await FFmpeg.fetchFile(file));
        
        // 進捗表示設定
        ffmpeg.setProgress(({ ratio }) => {
          const percent = Math.round(ratio * 100);
          document.getElementById('progressBar').style.width = `${percent}%`;
          document.getElementById('status').innerText = `圧縮中... ${percent}%`;
        });

        // 圧縮実行 (解像度を720pにダウンスケール)
        await ffmpeg.run(
          '-i', file.name,
          '-vf', 'scale=-2:720',
          '-c:v', 'libx264',
          '-crf', '28',
          '-preset', 'fast',
          '-c:a', 'aac',
          '-b:a', '64k',
          'output.mp4'
        );

        // 出力ファイル取得
        const data = ffmpeg.FS('readFile', 'output.mp4');
        const blob = new Blob([data.buffer], { type: 'video/mp4' });
        
        // 圧縮後のサイズチェック
        const compressedSize = blob.size / 1024 / 1024;
        if (compressedSize > 50) {
          alert(`圧縮後も50MBを超えています (${compressedSize.toFixed(2)}MB)。別のファイルをお試しください。`);
          resetUI();
          return;
        }

        document.getElementById('status').innerText = `圧縮完了! (${compressedSize.toFixed(2)}MB) アップロード中...`;
        await uploadToGAS(blob);
        
      } catch (err) {
        console.error('エラー:', err);
        document.getElementById('status').innerText = `エラー: ${err.message || err}`;
        resetUI();
      }
    }

    function resetUI() {
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('compressButton').disabled = false;
      processing = false;
    }

    async function uploadToGAS(blob) {
      try {
        const formData = new FormData();
        formData.append('file', blob, 'compressed_video.mp4');
        
        const response = await fetch(
          'https://script.google.com/macros/s/AKfycbzta37TGo2wIQ3IQOUm2dyLn_RXL7eIxeE2HYLmzRtM0xT2O0ffeoZ0gL66EXTjc-iyhg/exec', 
          {
            method: 'POST',
            body: formData
          }
        );
        
        const result = await response.text();
        document.getElementById('status').innerText = `アップロード成功: ${result}`;
      } catch (err) {
        document.getElementById('status').innerText = `アップロード失敗: ${err.message || err}`;
      } finally {
        resetUI();
      }
    }

    // 初期化
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('status').innerText = 'ファイルを選択してください';
    });
  </script>
</body>
</html>
