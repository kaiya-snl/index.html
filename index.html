<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>動画アップロード＆圧縮</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 30px; }
    #spinner { display: none; margin: 20px auto; border: 6px solid #ccc; border-top: 6px solid #4285F4; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .progress-bar { width: 80%; height: 20px; background-color: #f1f1f1; margin: 20px auto; border-radius: 10px; overflow: hidden; }
    .progress { height: 100%; background-color: #4285F4; width: 0%; transition: width 0.3s; }
    #fileInfo { margin: 10px 0; }
    .error { color: red; margin-top: 10px; font-weight: bold; }
    #logs { 
      max-height: 200px; 
      overflow-y: auto; 
      text-align: left; 
      padding: 10px; 
      border: 1px solid #ddd; 
      margin: 20px auto; 
      font-family: monospace; 
      background: #f8f8f8; 
    }
  </style>
</head>
<body>
  <h1>動画アップロード＆圧縮</h1>
  <input type="file" id="videoInput" accept="video/*"><br>
  <div id="fileInfo"></div>
  <button id="compressButton" disabled>圧縮してアップロード</button>
  <div id="spinner"></div>
  <div class="progress-bar">
    <div class="progress" id="progressBar"></div>
  </div>
  <p id="status">ファイルを選択してください</p>
  <div id="error" class="error"></div>
  <div id="logs">ログ出力エリア:</div>

  <!-- FFmpegライブラリを最後に読み込む -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.7/dist/ffmpeg.min.js"></script>
  <script>
    // ログ出力関数
    function log(message) {
      const logsDiv = document.getElementById('logs');
      logsDiv.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
      logsDiv.scrollTop = logsDiv.scrollHeight;
      console.log(message);
    }

    let ffmpeg = null;
    let currentFile = null;
    let processing = false;
    let ffmpegLoaded = false;

    // 初期化処理
    window.addEventListener('load', async () => {
      log('ページの読み込み完了');
      
      try {
        // FFmpegライブラリが利用可能か確認
        if (typeof FFmpeg === 'undefined') {
          throw new Error('FFmpegライブラリが読み込まれていません');
        }
        
        log('FFmpegライブラリを検出');
        ffmpegLoaded = true;
        
        // ファイル選択イベント
        document.getElementById('videoInput').addEventListener('change', (e) => {
          if (e.target.files.length > 0) {
            currentFile = e.target.files[0];
            document.getElementById('compressButton').disabled = false;
            document.getElementById('fileInfo').innerHTML = 
              `<strong>選択ファイル:</strong> ${currentFile.name}<br>
               <strong>サイズ:</strong> ${(currentFile.size / 1024 / 1024).toFixed(2)} MB`;
            document.getElementById('status').innerText = '「圧縮してアップロード」ボタンをクリック';
            log(`ファイル選択: ${currentFile.name} (${(currentFile.size / 1024 / 1024).toFixed(2)} MB)`);
          }
        });

        // 圧縮ボタンクリックイベント
        document.getElementById('compressButton').addEventListener('click', async () => {
          if (processing) return;
          if (!currentFile) {
            showError('動画ファイルを選択してください');
            return;
          }
          processing = true;
          document.getElementById('compressButton').disabled = true;
          await startCompression();
        });
        
        log('イベントリスナー登録完了');
        document.getElementById('status').innerText = '準備完了';
        
      } catch (err) {
        showError(`初期化エラー: ${err.message}`);
        log(`初期化エラー: ${err.stack}`);
      }
    });

    // エラー表示関数
    function showError(message) {
      const errorDiv = document.getElementById('error');
      errorDiv.innerText = message;
      setTimeout(() => errorDiv.innerText = '', 10000);
      log(`エラー: ${message}`);
    }

    // FFmpegの初期化関数
    async function initFFmpeg() {
      if (!ffmpegLoaded) {
        throw new Error('FFmpegライブラリが利用できません');
      }

      if (!ffmpeg) {
        log('FFmpegインスタンスを作成中...');
        const { createFFmpeg, fetchFile } = FFmpeg;
        ffmpeg = createFFmpeg({
          log: true,
          progress: ({ ratio }) => {
            const percent = Math.round(ratio * 100);
            document.getElementById('status').innerText = `ffmpeg.wasm 初期化中... ${percent}%`;
          }
        });
        
        log('ffmpeg.load() を呼び出し');
        await ffmpeg.load();
        log('ffmpeg.wasm のロード完了');
      }
      return ffmpeg;
    }

    // 圧縮処理
    async function startCompression() {
      try {
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('status').innerText = 'ffmpeg.wasm をロード中...';
        
        const file = currentFile;
        log(`処理開始: ${file.name}`);
        
        // ファイルサイズチェック (100MB制限)
        if (file.size > 100 * 1024 * 1024) {
          showError('ファイルサイズが100MBを超えています。より小さいファイルを選択してください。');
          resetUI();
          return;
        }

        // FFmpeg初期化
        const ffmpegInstance = await initFFmpeg();
        document.getElementById('status').innerText = '圧縮処理を開始...';
        log('ffmpegインスタンス準備完了');
        
        // ファイルシステムに書き込み
        log('ファイルをメモリに書き込み中...');
        ffmpegInstance.FS('writeFile', file.name, await FFmpeg.fetchFile(file));
        log('ファイル書き込み完了');
        
        // 進捗表示設定
        ffmpegInstance.setProgress(({ ratio }) => {
          const percent = Math.round(ratio * 100);
          document.getElementById('progressBar').style.width = `${percent}%`;
          document.getElementById('status').innerText = `圧縮中... ${percent}%`;
        });

        // 圧縮実行
        log('圧縮コマンド実行開始');
        await ffmpegInstance.run(
          '-i', file.name,
          '-vf', 'scale=-2:720',
          '-c:v', 'libx264',
          '-crf', '28',
          '-preset', 'fast',
          '-c:a', 'aac',
          '-b:a', '64k',
          'output.mp4'
        );
        log('圧縮コマンド実行完了');

        // 出力ファイル取得
        const data = ffmpegInstance.FS('readFile', 'output.mp4');
        const blob = new Blob([data.buffer], { type: 'video/mp4' });
        
        // 圧縮後のサイズチェック
        const compressedSize = blob.size / 1024 / 1024;
        log(`圧縮後サイズ: ${compressedSize.toFixed(2)}MB`);
        
        if (compressedSize > 50) {
          showError(`圧縮後も50MBを超えています (${compressedSize.toFixed(2)}MB)。別のファイルをお試しください。`);
          resetUI();
          return;
        }

        document.getElementById('status').innerText = `圧縮完了! (${compressedSize.toFixed(2)}MB) アップロード中...`;
        await uploadToGAS(blob);
        
      } catch (err) {
        console.error('エラー:', err);
        showError(`処理エラー: ${err.message || err}`);
        log(`エラーの詳細: ${err.stack}`);
        resetUI();
      }
    }

    // UIリセット
    function resetUI() {
      document.getElementById('spinner').style.display = 'none';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('compressButton').disabled = false;
      processing = false;
    }

    // GASへのアップロード
    async function uploadToGAS(blob) {
      try {
        document.getElementById('status').innerText = 'サーバーに送信中...';
        log('アップロード処理開始');
        
        // Base64エンコードして送信
        const reader = new FileReader();
        const result = await new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
        
        const base64Data = result.split(',')[1];
        log(`Base64エンコード完了 (サイズ: ${base64Data.length} バイト)`);
        
        const response = await fetch(
          'https://script.google.com/macros/s/AKfycbzta37TGo2wIQ3IQOUm2dyLn_RXL7eIxeE2HYLmzRtM0xT2O0ffeoZ0gL66EXTjc-iyhg/exec', 
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `filedata=${encodeURIComponent(base64Data)}&filename=${encodeURIComponent(currentFile.name)}&mimetype=video/mp4`
          }
        );
        
        if (!response.ok) {
          throw new Error(`サーバーエラー: ${response.status}`);
        }
        
        const text = await response.text();
        log(`アップロード応答: ${text}`);
        document.getElementById('status').innerText = `アップロード成功: ${text}`;
      } catch (err) {
        showError(`アップロード失敗: ${err.message || err}`);
        log(`アップロードエラー: ${err.stack}`);
      } finally {
        resetUI();
      }
    }
  </script>
</body>
</html>
